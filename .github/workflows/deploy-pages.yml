name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Build site artifact
        env:
          COVEO_ACCESS_TOKEN: ${{ secrets.COVEO_ACCESS_TOKEN }}
          COVEO_ORGANIZATION_ID: ${{ secrets.COVEO_ORGANIZATION_ID }}
          COVEO_PIPELINE: ${{ secrets.COVEO_PIPELINE }}
        run: |
          set -euo pipefail

          for var in COVEO_ACCESS_TOKEN COVEO_ORGANIZATION_ID COVEO_PIPELINE; do
            if [ -z "${!var}" ]; then
              echo "Missing required GitHub secret: $var"
              exit 1
            fi
          done

          mkdir -p dist
          cp index.html dist/index.html
          cp -R static dist/static

          python3 - <<'PY'
          from pathlib import Path
          import os

          path = Path('dist/index.html')
          html = path.read_text(encoding='utf-8')

          replacements = {
              '__COVEO_ACCESS_TOKEN__': os.environ['COVEO_ACCESS_TOKEN'],
              '__COVEO_ORGANIZATION_ID__': os.environ['COVEO_ORGANIZATION_ID'],
              '__COVEO_PIPELINE__': os.environ['COVEO_PIPELINE'],
          }

          for placeholder, value in replacements.items():
              html = html.replace(placeholder, value)

          if '__COVEO_' in html:
              raise SystemExit('One or more placeholders were not replaced')

          path.write_text(html, encoding='utf-8')
          PY

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
